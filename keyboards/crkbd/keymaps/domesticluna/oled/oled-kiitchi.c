// Copyright 2021 @filterpaper
// SPDX-License-Identifier: GPL-2.0+

/* Graphical Luna / Felix animation, driven by key press timer or WPM.
   Frames are 4x3 on OLED and oriented for OLED_ROTATION_270.

   Modified from @HellSingCoder's Luna dog
   (https://github.com/HellSingCoder/qmk_firmware/tree/master/keyboards/sofle/keymaps/helltm)

   Includes white Felix dog frames from @ItsWaffIe
   (https://github.com/ItsWaffIe/waffle_corne/blob/proton-c/firmware/oled.c)


   Usage guide
   1 Place this file next to keymap.c or in userspace.
   2 Add the following lines into rules.mk:
        OLED_ENABLE = yes
        SRC += oled-luna.c
   3 Animation defaults to Luna, an outlined dog. Add
     'OPT_DEFS += -DFELIX' into rules.mk for "filled" version.
   4 To animate with WPM, add 'WPM_ENABLE = yes' into rules.mk.
     Otherwise add the following 'process_record_user()' code block into
     keymap.c to trigger animation tap timer with key presses:
        bool process_record_user(uint16_t keycode, keyrecord_t *record) {
            if (record->event.pressed) {
                extern uint32_t tap_timer;
                tap_timer = timer_read32();
            }
            return true;
        }
   5 The 'oled_task_user()' calls 'render_mod_status()' for secondary OLED.
     It can be replaced with your own function, or deleted.
*/

#include QMK_KEYBOARD_H

#ifndef CMK
#	define CMK 0
#	define QWR 1

#endif



#define LUNA_SIZE 96
#define LUNA_FRAME_DURATION 500 // milliseconds
#define RUN_INTERVAL  LUNA_FRAME_DURATION*2
#define WALK_INTERVAL LUNA_FRAME_DURATION*8
#define STAND_INTERVAL LUNA_FRAME_DURATION*60

char wpm_str[10];

uint32_t tap_timer = 0;

static char const sleep[][LUNA_SIZE] PROGMEM = { {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x68, 0x68, 0x58, 0x00, 0x31, 0x29, 0x29, 0x25, 0x23, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x14, 0x7c, 0xac, 0x24, 0x04, 0x84, 
0x04, 0x24, 0xac, 0x7c, 0x14, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x1d, 0x27, 0x39, 
0x27, 0x3d, 0x2a, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
}, {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x40, 0xc0, 0x40, 0x00, 0x34, 0x34, 0x2c, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x14, 0x7c, 0xac, 0x24, 0x04, 0x84, 
0x04, 0x24, 0xac, 0x7c, 0x15, 0x09, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x1d, 0x27, 0x39, 
0x27, 0x3d, 0x2a, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
} };
static char const stand[][LUNA_SIZE] PROGMEM = { {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x80, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x05, 0x1e, 0xa7, 0x4d, 0x41, 0x51, 
0x41, 0x4d, 0xa7, 0x1e, 0x05, 0x83, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x04, 0x0f, 0x10, 0x08, 
0x10, 0x0f, 0x04, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
}, {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0a, 0x3d, 0x4e, 0x9a, 0x82, 0xa2, 
0x82, 0x9a, 0x4e, 0x3d, 0x0a, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x05, 0x0e, 0x10, 0x08, 
0x10, 0x0e, 0x05, 0x0a, 0x08, 0x08, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
} };
static char const walk[][LUNA_SIZE] PROGMEM = { {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0x40, 0x80, 0xc0, 
0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x3e, 0x47, 0x80, 0x81, 
0x83, 0x93, 0x93, 0x46, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x02, 0x02, 0x04, 0x1f, 0x2c, 
0x12, 0x20, 0x1f, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
}, {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x60, 0xa0, 0x40, 0xe0, 
0xe0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x10, 0x14, 0x44, 0x44, 0x00, 0x1f, 0x23, 0xc0, 0x40, 
0x41, 0x49, 0xc9, 0x23, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x04, 0x04, 0x04, 0x07, 0x1f, 0x10, 
0x09, 0x16, 0x0e, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
} };
static char const run[][LUNA_SIZE] PROGMEM = { {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0xc0, 0x40, 0xe0, 0x60, 0xa0, 0xc0, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x03, 0x9f, 0xe2, 0x40, 0x40, 
0x45, 0x4d, 0xa2, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x02, 0x1b, 0x17, 0x19, 0x09, 0x18, 0x1e, 
0x10, 0x0e, 0x1f, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
}, {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x18, 0x28, 0x78, 0xe8, 0x0c, 
0x0c, 0x0c, 0x5c, 0xd8, 0x30, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x80, 0x00, 0x24, 0x84, 0xc0, 0xf0, 0x18, 0x1f, 0x96, 
0xf4, 0xec, 0xfc, 0x34, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x03, 0x01, 0x03, 
0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
} };
static char const screm[][LUNA_SIZE] PROGMEM = { {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0x80, 0x00, 0x00, 0x2e, 0x00, 
0x2e, 0x00, 0x00, 0x80, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x35, 0x5e, 0xa7, 0x4d, 0x49, 0xa1, 
0x49, 0x4d, 0xa7, 0x5e, 0x35, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x10, 0x08, 
0x10, 0x0f, 0x08, 0x08, 0x08, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
}, {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0x80, 0x00, 0x00, 0x00, 0x2e, 
0x00, 0x00, 0x00, 0x80, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x43, 0xa5, 0xbe, 0xa7, 0x4d, 0x49, 0x61, 
0x49, 0x4d, 0xa7, 0xbe, 0xa5, 0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x10, 0x08, 
0x10, 0x0f, 0x08, 0x08, 0x08, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
} };
static char const sneak[][LUNA_SIZE] PROGMEM = { {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x88, 0x98, 
0x7a, 0x8c, 0x04, 0x04, 0x34, 0x14, 0x88, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x04, 0x04, 0x02, 0x02, 0x1b, 0x17, 0x19, 0x09, 0x18, 0x1e, 
0x10, 0x0e, 0x1f, 0x1d, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
}, {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x88, 0x98, 
0x7a, 0x8c, 0x04, 0x24, 0x24, 0x24, 0x88, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x02, 0x02, 0x1b, 0x17, 0x19, 0x09, 0x18, 0x1e, 
0x1c, 0x0c, 0x17, 0x19, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
} };



static void render_logo(void) {
	//static char const corne_logo[] PROGMEM = {
	//		0x80, 0x81, 0x82, 0x83, 0x84,
	//		0xa0, 0xa1, 0xa2, 0xa3, 0xa4,
	//		0xc0, 0xc1, 0xc2, 0xc3, 0xc4, 0};
	//static char const katakana[] PROGMEM = {
	//	0x20, 0xd1, 0xd2, 0xd3, 0x20, 0};


    oled_set_cursor(0,6);
    sprintf(wpm_str, " WPM: %03d", get_current_wpm());
    oled_write(wpm_str, false);
	

}


static void luna_action(char const action[][LUNA_SIZE]) {
	static uint8_t current_frame = 0;
	current_frame = (current_frame + 1) & 1;
	oled_write_raw_P(action[current_frame], LUNA_SIZE);
}


static void render_luna_status(void) {
	// Animation timer
	static uint16_t anim_timer = 0;

#ifdef WPM_ENABLE
	static uint8_t prev_wpm = 0;
	// Update tap_timer with sustained WPM
	if (get_current_wpm() > prev_wpm || get_mods()) {
		tap_timer = timer_read32();
	}
	prev_wpm = get_current_wpm();
#endif

	void animate_luna(void) {
		render_logo();
		oled_set_cursor(0,8);
		if (get_mods() & MOD_MASK_SHIFT || host_keyboard_led_state().caps_lock) {
			luna_action(screm);
		} else if (get_mods() & MOD_MASK_CAG) {
			luna_action(sneak);
		} else if (timer_elapsed32(tap_timer) < RUN_INTERVAL) {
			luna_action(run);
		} else if (timer_elapsed32(tap_timer) < WALK_INTERVAL) {
			luna_action(walk);
		} else if (timer_elapsed32(tap_timer) < STAND_INTERVAL) {
			luna_action(stand);			
		} else {
			luna_action(sleep);
		}
	}

	if (timer_elapsed32(tap_timer) > OLED_TIMEOUT) {
		oled_off();
	} else if (timer_elapsed(anim_timer) > LUNA_FRAME_DURATION) {
		anim_timer = timer_read();
		animate_luna();
	}
}


// Init and rendering calls
oled_rotation_t oled_init_user(oled_rotation_t const rotation) {
	return OLED_ROTATION_270;
}

bool oled_task_user(void) {
	extern void render_mod_status(void);

	is_keyboard_master() ? render_luna_status() : render_mod_status();
	return false;
}
